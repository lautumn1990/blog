---
title: 通过containerd安装k8s集群
tags: [ k8s ]
categories: [ k8s ]
key: install-k8s
pageview: true
---

CentOS通过containerd安装k8s集群

<!--more-->

## 安装containerd

前置条件

```sh
cat <<EOF | sudo tee /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

# Setup required sysctl params, these persist across reboots.
cat <<EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF

# Apply sysctl params without reboot
sudo sysctl --system
```

安装containerd

```sh
sudo yum install -y yum-utils

sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo

sudo yum install containerd.io
```

修改配置

```sh
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
```

使用systemd的cgroup driver, 文件`/etc/containerd/config.toml`

```conf
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
  ...
  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
    SystemdCgroup = true
```

修改镜像源

```conf
[plugins]
  [plugins."io.containerd.grpc.v1.cri"]
    sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.5"
```

重启containerd

```sh
sudo systemctl restart containerd
```

## 安装kubeadmin

安装 `kubelet`, `kubeadm`, `kubectl` 等工具

```sh
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

# Set SELinux in permissive mode (effectively disabling it)
sudo setenforce 0
sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes

sudo systemctl enable --now kubelet
```

通过crictl进行调试

文件`/etc/crictl.yaml`

```sh
cat <<EOF > /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
EOF
```

`crictl pods`

以上内容在master和node节点都需要执行
{:.info}

### master执行

通过kubeadm生成默认config文件

`kubeadm config print init-defaults --kubeconfig ClusterConfiguration > kubeadm.yml`

修改kubeadm.yml文件，修改后如下（根据个人环境不同，可能不太一样）

1. 修改 criSocket：默认使用docker做为runtime，修改为containerd.sock，使用containerd做为runtime
1. 修改imageRepository，改为aliyun的镜像仓库地址
1. 修改podSubnet以及serviceSubnet，根据的自己的环境进行设置
1. 设置cgroupDriver为systemd

示例文件如下

```yaml
apiVersion: kubeadm.k8s.io/v1beta3
bootstrapTokens:
- groups:
  - system:bootstrappers:kubeadm:default-node-token
  token: abcdef.0123456789abcdef
  ttl: 24h0m0s
  usages:
  - signing
  - authentication
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 0.0.0.0
  bindPort: 6443
nodeRegistration:
  criSocket: /run/containerd/containerd.sock
  imagePullPolicy: IfNotPresent
  name: k8s-master
  taints: null
---
apiServer:
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta3
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controllerManager: {}
dns: {}
etcd:
  local:
    dataDir: /var/lib/etcd
imageRepository: registry.aliyuncs.com/google_containers
kind: ClusterConfiguration
kubernetesVersion: 1.22.0
networking:
  dnsDomain: cluster.local
  podSubnet: 172.16.0.204/24
  serviceSubnet: 10.96.0.0/12
scheduler: {}
```

- 查看、拉取相关镜像（可跳过，建议使用本地镜像，因为coredns镜像的原因，kubeadm init会拉取失败，参考下一步）
  - `kubeadm config images list --image-repository registry.aliyuncs.com/google_containers`
  - `kubeadm config images pull --image-repository registry.aliyuncs.com/google_containers`
  - 拉取后，如果使用本地镜像，请修改kubeadm.yml中的镜像拉取策略:imagePullPolicy，

- 准备好相关配置后，执行如下命令，初始化master集群
  - `kubeadm init --config=kubeadm.yml --upload-certs --ignore-preflight-errors=ImagePull`
  - `--ignore-preflight-errors`因为我使用的是默认imagePullPolicy, coredns会拉取失败，所以选择忽略
  - 建议还是先执行第5步，将所有镜像拉取到本地，使用本地镜像，初始化时间差不多
  - 到这一步基本配置完成，如果没有特殊问题，master集群应该正常启动
  - 通过crictl可以看到相关的pod已经启动

- 添加到`profile`
  - `echo "export KUBECONFIG=/etc/kubernetes/admin.conf" >> /etc/profile`
  - `source /etc/profile`

- 通过kubeadm join加入master时，要加上参数 `--cri-socket  /run/containerd/containerd.sock`
  - 指定使用containerd做为container runtime
  - 命令如下，master地址及token cert，master执行完Kubeadm init后，会有提示，在后面追加
  - `--cri-socket  /run/containerd/containerd.sock`执行
  - `kubeadm join 172.17.18.237:8080 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:f63893c3540a5b5032ba25c86293d54f118728476a6544478a93e8d051984c55 --cri-socket /run/containerd/containerd.sock`
  - 重新生成token, `kubeadm token create --print-join-command`, 查看token, `kubeadm token list --print-join-command`

----

### 参考

- [Bootstrapping clusters with kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/)
- [CentOS7中用kubeadm安装Kubernetes](https://developer.aliyun.com/article/626118)
- [K8s 部署（基于v1.22.0 + containerd）](https://blog.csdn.net/lmfshd/article/details/119864659)
- [container-runtimes#containerd](https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd)
